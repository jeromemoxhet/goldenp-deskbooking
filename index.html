<!--
  Application web de réservation de bureau - Golden Palace
  Version : MAP RENDERING FIX
  
  Mises à jour :
  - BUGFIX CRITIQUE : Restauration de l'affichage des zones "Design Studio" et "Online Products" qui avaient disparu.
  - STABILITY : Amélioration de la fonction de création des bureaux (create) pour éviter les conflits DOM (remplacement de innerHTML+= par appendChild).
-->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Golden Palace - Réservation</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined|Material+Icons+Round" rel="stylesheet">
    <!-- Google Fonts Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Slate 50 */
            color: #0f172a; /* Slate 900 */
            padding-bottom: 140px; /* Espace pour le footer sticky */
        }

        /* --- Custom UI --- */
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border: 1px solid #e2e8f0;
            margin-bottom: 1.5rem;
            overflow: visible; 
        }

        .section-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f1f5f9;
            background: #ffffff;
            display: flex;
            align-items: center;
            border-radius: 16px 16px 0 0;
        }

        .step-badge {
            background-color: #c39400; /* GOLDEN */
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.8rem;
            margin-right: 0.75rem;
        }

        .section-title {
            font-weight: 800;
            font-size: 1rem;
            color: #334155;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        /* --- Desk Styling --- */
        .desk-wrapper {
            position: relative;
            width: 3.8rem;
            height: 4.5rem;
            z-index: 1;
        }
        .desk-wrapper:hover { z-index: 10; }

        .desk-box {
            width: 100%;
            height: 100%;
            border-radius: 0.75rem;
            border-width: 2px;
            transition: transform 0.15s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.15s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .desk-wrapper:active .desk-box { transform: scale(0.95); }
        
        .floating-badge {
            position: absolute;
            top: -8px; 
            right: -8px; 
            border-radius: 50%;
            width: 24px; 
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 30;
            border: 2px solid white;
            font-size: 14px; 
            background-color: #334155;
            color: white;
            pointer-events: none;
        }
        
        /* Sticky Footer */
        #sticky-action-bar {
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #sticky-action-bar.visible { transform: translateY(0); }

        .legend-pill {
            display: flex; align-items: center; font-size: 0.75rem; font-weight: 600; color: #64748b;
            background: white; padding: 4px 8px; border-radius: 6px; border: 1px solid #e2e8f0;
        }

        .zone-header {
            width: 100%; text-align: center; font-size: 0.7rem; font-weight: 800;
            text-transform: uppercase; letter-spacing: 0.08em; color: #94a3b8;
            background-color: #f1f5f9; padding: 0.5rem; border-radius: 8px;
            margin-bottom: 1rem; border: 1px dashed #cbd5e1;
        }

        .toggle-checkbox:checked { right: 0; border-color: #c39400; } /* GOLDEN */
        .toggle-checkbox:checked + .toggle-label { background-color: #c39400; } /* GOLDEN */
        .toggle-checkbox:checked + .toggle-label:before { transform: translateX(100%); }
        
        .lang-btn-active { background-color: #f1f5f9; color: #334155; }
        .lang-btn-inactive { color: #94a3b8; }
        .lang-btn-inactive:hover { background-color: #f8fafc; }
        
        .admin-button-group {
            height: 40px; 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        .admin-button-group button {
            height: 100%;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .info-grid-row {
            display: grid;
            grid-template-columns: 1fr max-content;
            align-items: center;
            padding: 4px 0;
        }

        /* Weekly Stats UI Compact */
        .week-stat-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            background-color: white;
            transition: all 0.2s;
            cursor: pointer;
            min-width: 50px;
            position: relative;
            overflow: hidden;
        }
        .week-stat-card:hover {
            border-color: #cbd5e1;
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .week-stat-card.active {
            background-color: #fffbeb; /* Amber 50 - Lighter Gold */
            border-color: #c39400; /* GOLDEN */
            box-shadow: 0 0 0 2px rgba(195, 148, 0, 0.2); /* GOLDEN Glow */
        }
        .week-stat-card.locked {
            background-color: #f1f5f9;
            border-color: #e2e8f0;
            opacity: 0.8;
        }
        .week-stat-day { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; color: #64748b; margin-bottom: 2px; }
        .week-stat-content { display: flex; align-items: center; gap: 2px; color: #0f172a; }
        .week-stat-count { font-size: 0.9rem; font-weight: 800; }
        .week-lock-icon { position: absolute; top: 2px; right: 2px; font-size: 10px; color: #94a3b8; }
        
        /* LOGIN OVERLAY ANIMATION */
        .fade-out { opacity: 0; pointer-events: none; transition: opacity 0.5s ease; }
    </style>
</head>
<body class="antialiased text-slate-800">

    <!-- LOGIN WALL / OVERLAY -->
    <div id="login-overlay" class="fixed inset-0 z-[100] bg-slate-50 flex flex-col items-center justify-center p-6 transition-opacity duration-500">
        <div class="bg-white p-8 rounded-2xl shadow-xl border border-slate-200 max-w-sm w-full text-center relative">
            
            <!-- OVERLAY LANGUAGE SWITCHER -->
            <div class="absolute top-4 right-4 flex gap-1">
                <button id="overlay-lang-fr" class="text-[10px] font-bold px-2 py-1 rounded hover:bg-slate-100 text-slate-400 transition">FR</button>
                <button id="overlay-lang-nl" class="text-[10px] font-bold px-2 py-1 rounded hover:bg-slate-100 text-slate-400 transition">NL</button>
                <button id="overlay-lang-en" class="text-[10px] font-bold px-2 py-1 rounded hover:bg-slate-100 text-slate-400 transition">EN</button>
            </div>

            <!-- LOGO (OVERLAY) -->
            <img src="goldenpalace_logo.svg" alt="Golden Palace" class="h-24 mx-auto mb-8 object-contain">
            
            <div class="mb-8">
                <h1 class="text-2xl font-black text-slate-800 tracking-tight leading-tight uppercase" data-i18n="login_title">Espace Réservation de Sièges</h1>
            </div>
            
            <!-- GOLDEN BAR -->
            <div class="w-16 h-1 bg-[#c39400] rounded-full mx-auto mb-8"></div>
            
            <p class="text-sm text-slate-600 mb-8 leading-relaxed" data-i18n="login_intro">
                Veuillez vous authentifier avec votre compte Microsoft pour accéder aux réservations.
            </p>

            <!-- GOLDEN BUTTON -->
            <button id="main-login-btn" class="w-full py-3.5 px-4 bg-[#c39400] hover:bg-[#a37c00] text-white font-bold rounded-xl shadow-lg shadow-[#c39400]/30 transition transform active:scale-95 flex items-center justify-center gap-3">
                <span class="material-icons-round">login</span>
                <span data-i18n="login_btn_text">Connexion SSO</span>
            </button>
            
            <p class="text-[10px] text-slate-400 mt-6 font-medium" data-i18n="login_secure">
                Accès sécurisé et restreint au personnel.
            </p>
        </div>
    </div>

    <!-- MAIN APP CONTENT -->
    <div id="app-container" class="w-full max-w-5xl mx-auto relative px-4 pt-6 filter blur-sm transition-all duration-500 pointer-events-none">
        
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div class="flex items-center gap-6">
                <!-- LOGO (HEADER) -->
                <img src="goldenpalace_logo.svg" alt="Golden Palace" class="h-16 w-auto object-contain hidden md:block">
                
                <div>
                    <h1 class="text-3xl font-black text-slate-800 tracking-tight leading-tight" data-i18n="main_title">Réservation de sièges</h1>
                    <p class="text-sm text-slate-500 font-medium mt-1" data-i18n="subtitle">Paysager - Croix de guerre 120</p>
                </div>
            </div>

            <div class="flex flex-col md:flex-row items-end md:items-center gap-4">
                
                <!-- USER INFO HEADER AREA -->
                <div id="auth-section" class="flex items-center gap-3 order-first md:order-none opacity-0 transition-opacity duration-300">
                    <div id="user-logged-in" class="flex items-center gap-2 bg-white border border-slate-200 p-1 pr-3 rounded-full shadow-sm">
                        <!-- Golden Avatar -->
                        <div id="user-avatar" class="w-8 h-8 rounded-full bg-[#fff8e1] flex items-center justify-center text-[#c39400] font-bold text-xs border border-[#c39400]/20 uppercase">U</div>
                        <div class="flex flex-col">
                            <span id="user-display-name" class="text-[10px] font-bold text-slate-700 leading-tight">User</span>
                            <span class="text-[9px] text-green-500 font-bold leading-tight" data-i18n="status_connected">Connecté</span>
                        </div>
                        <button id="logout-btn" class="text-slate-400 hover:text-red-500 transition ml-2" title="Déconnexion">
                            <span class="material-icons-round text-sm">logout</span>
                        </button>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <div class="bg-white border border-slate-200 rounded-lg p-1 flex shadow-sm">
                        <button id="lang-fr" class="px-3 py-1 text-xs font-bold rounded-md transition">FR</button>
                        <button id="lang-nl" class="px-3 py-1 text-xs font-bold rounded-md transition">NL</button>
                        <button id="lang-en" class="px-3 py-1 text-xs font-bold rounded-md transition">EN</button>
                    </div>
                    <div class="flex items-center">
                        <label for="admin-mode-toggle" class="flex items-center cursor-pointer">
                            <div class="relative">
                                <input type="checkbox" id="admin-mode-toggle" class="sr-only">
                                <div class="block bg-slate-200 w-10 h-6 rounded-full transition-colors duration-300 ease-in-out" id="toggle-bg"></div>
                                <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform duration-300 ease-in-out shadow-sm"></div>
                            </div>
                            <div class="ml-3 text-xs font-bold text-slate-400 uppercase tracking-wide" data-i18n="admin_mode">Admin</div>
                        </label>
                    </div>
                </div>
            </div>
        </header>

        <!-- Toast -->
        <div id="message-area" class="hidden fixed top-6 left-1/2 transform -translate-x-1/2 z-[60] px-6 py-3 rounded-full shadow-2xl font-bold text-sm text-center animate-bounce-in transition-all"></div>

        <!-- Password Modal -->
        <div id="password-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-[70] hidden">
            <div class="bg-white rounded-2xl shadow-2xl p-6 w-80 transform transition-all scale-100">
                <h3 class="text-lg font-bold text-slate-800 mb-2 text-center" data-i18n="admin_access">Accès Admin</h3>
                <input type="password" id="admin-password-input" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl mb-4 text-center focus:ring-2 focus:ring-[#c39400] outline-none font-bold text-lg" placeholder="••••••">
                <div class="grid grid-cols-2 gap-3">
                    <button id="cancel-password-btn" class="py-2 text-slate-500 hover:bg-slate-50 rounded-lg font-bold text-sm" data-i18n="cancel">Annuler</button>
                    <button id="submit-password-btn" class="py-2 bg-[#c39400] text-white rounded-lg font-bold text-sm shadow-md hover:bg-[#a37c00]" data-i18n="validate">Valider</button>
                </div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="admin-config-panel" class="hidden mb-6 bg-red-50 border-2 border-red-200 rounded-xl p-5 shadow-inner">
            <h2 class="section-title text-red-700 mb-4 flex items-center gap-2">
                <span class="material-icons-round text-lg">admin_panel_settings</span> <span data-i18n="admin_config">Configuration Admin</span>
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <!-- Add/Edit User -->
                <div class="md:col-span-1">
                    <label class="block text-xs font-bold text-red-400 uppercase mb-1" id="admin-user-action-label" data-i18n="add_user">Ajouter Utilisateur</label>
                    <div class="flex gap-1 mb-2">
                        <input id="admin-new-user-name" placeholder="Prénom Nom" class="w-full p-2 text-xs border border-red-200 rounded focus:ring-red-500">
                        <select id="admin-new-user-dept" class="w-full p-2 text-xs border border-red-200 rounded bg-white focus:ring-red-500"></select>
                        <div class="admin-button-group w-1/2 flex flex-col gap-1">
                            <button id="admin-add-user-btn" class="bg-slate-700 text-white px-3 py-2 rounded text-xs font-bold hover:bg-slate-800 transition shadow-sm" data-i18n="add">Ajouter</button>
                            <button id="admin-cancel-edit-btn" class="hidden bg-slate-300 text-slate-600 px-3 py-1 rounded text-[10px] font-bold hover:bg-slate-400 transition" data-i18n="cancel">Annuler</button>
                        </div>
                    </div>
                    <div id="admin-users-list" class="h-24 overflow-y-auto bg-white rounded border border-red-100 p-1 space-y-1"></div>
                </div>
                <!-- Rules -->
                <div class="md:col-span-1">
                    <label class="block text-xs font-bold text-red-400 uppercase mb-1" data-i18n="fixed_rules">Règles Fixes</label>
                    <div class="flex gap-1 flex-wrap mb-2">
                        <select id="admin-day-select" class="w-full p-2 text-xs border border-red-200 rounded font-bold bg-white focus:ring-red-500"></select>
                        <select id="admin-desk-select" class="w-1/3 p-2 text-xs border border-red-200 rounded bg-white focus:ring-red-500"></select>
                        <select id="admin-rule-user-select" class="flex-1 p-2 text-xs border border-red-200 rounded bg-white focus:ring-red-500"></select>
                        <div class="admin-button-group w-full">
                            <button id="admin-add-rule-btn" class="bg-slate-700 text-white py-2 rounded text-xs font-bold hover:bg-slate-800 transition shadow-sm" data-i18n="add">Ajouter</button>
                        </div>
                    </div>
                    <div id="admin-rules-list" class="h-24 overflow-y-auto bg-white rounded border border-red-100 p-1 space-y-1"></div>
                </div>
                <!-- Disable -->
                <div class="md:col-span-1">
                    <label class="block text-xs font-bold text-red-400 uppercase mb-1" data-i18n="disable_desk">Désactiver Bureau</label>
                    <div class="flex gap-1 mb-2">
                        <select id="admin-disable-desk-select" class="flex-1 p-2 text-xs border border-red-200 rounded focus:ring-red-500"></select>
                        <div class="admin-button-group w-1/3">
                            <button id="admin-disable-btn" class="bg-red-600 text-white px-3 py-2 rounded text-xs font-bold hover:bg-red-700 transition shadow-sm" data-i18n="block">Bloquer</button>
                        </div>
                    </div>
                    <div id="admin-disabled-list" class="h-24 overflow-y-auto bg-white rounded border border-red-100 p-1 space-y-1"></div>
                </div>
                <!-- Settings -->
                <div class="md:col-span-1">
                    <label class="block text-xs font-bold text-red-400 uppercase mb-1" data-i18n="booking_settings">Paramètres Réservation</label>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div>
                            <span class="text-[9px] text-slate-500 font-bold">Heure limite</span>
                            <input type="number" id="admin-cutoff-hour" class="w-full p-2 text-xs border border-red-200 rounded" min="0" max="23" placeholder="5">
                        </div>
                        <div>
                            <span class="text-[9px] text-slate-500 font-bold">Décalage Jours</span>
                            <input type="number" id="admin-day-offset" class="w-full p-2 text-xs border border-red-200 rounded" min="-5" max="5" placeholder="0">
                        </div>
                    </div>
                    <div class="admin-button-group w-full">
                        <button id="admin-save-settings-btn" class="bg-slate-700 text-white py-2 rounded text-xs font-bold hover:bg-slate-800 transition shadow-sm w-full" data-i18n="save_settings">Sauvegarder</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- STEP 1 -->
        <section class="card relative z-10">
            <div class="section-header">
                <div class="step-badge">1</div>
                <h2 class="section-title" data-i18n="my_info">Mes Informations</h2>
            </div>
            <div class="p-6 bg-slate-50/50">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2" data-i18n="identity">Identité</label>
                            <div class="relative">
                                <!-- Golden Focus Ring -->
                                <select id="user-select" class="w-full p-3 pl-4 bg-white border border-slate-200 rounded-xl text-slate-800 font-semibold focus:ring-2 focus:ring-[#c39400] outline-none appearance-none cursor-pointer shadow-sm"></select>
                                <span class="material-icons-round absolute right-3 top-3 text-slate-400 pointer-events-none">expand_more</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2" data-i18n="date">Date</label>
                            <div class="flex bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                                <input type="date" id="date-selector" class="flex-1 p-3 outline-none text-slate-800 font-semibold cursor-pointer">
                                <!-- Golden Date Label Background -->
                                <div id="day-label" class="px-5 bg-[#fff8e1] border-l border-[#ffe082] flex items-center text-[#c39400] font-bold text-sm uppercase">...</div>
                            </div>
                        </div>

                          <!-- WEEKLY AVAILABILITY WIDGET -->
                          <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2" data-i18n="week_availability">Disponibilités Semaine</label>
                            <div id="weekly-availability-container" class="grid grid-cols-5 gap-2">
                                <!-- Generated by JS -->
                            </div>
                        </div>
                    </div>

                    <div id="user-info-card" class="hidden bg-white rounded-xl border border-slate-200 p-5 shadow-sm flex flex-col justify-center relative h-full">
                        <div class="info-grid-row border-b border-slate-100 mb-3 pb-3">
                            <span class="text-xs text-slate-400 font-bold uppercase" data-i18n="department">Département</span>
                            <span id="user-dept-badge" class="text-[10px] px-2 py-1 rounded-full font-bold text-white uppercase tracking-wide bg-slate-300">...</span>
                        </div>
                        <div class="info-grid-row mb-4">
                            <span class="text-xs text-slate-400 font-bold uppercase" data-i18n="friday_goal">Objectif Vendredi</span>
                            <span id="user-friday-stats" class="text-sm font-bold text-slate-700">...</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-xs text-slate-400 font-bold uppercase mb-2" data-i18n="fixed_days">Jours Fixes</span>
                            <div id="user-fixed-days" class="flex flex-col gap-1 text-sm">
                                <span class="text-xs italic text-slate-400">...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- STEP 2 -->
        <section class="card mb-32 relative z-0">
            <div class="section-header justify-between sticky top-0 bg-white/95 backdrop-blur z-30 shadow-sm">
                <div class="flex items-center">
                    <div class="step-badge">2</div>
                    <h2 class="section-title" data-i18n="book_place">Je réserve ma place</h2>
                </div>
                <div class="hidden sm:flex gap-2">
                    <div class="legend-pill border-green-400 text-green-700"><span class="material-icons-round text-sm mr-1">check_circle_outline</span> <span data-i18n="free">Libre</span></div>
                    <div class="legend-pill border-red-300 bg-red-50 text-red-600"><span class="material-icons-round text-sm mr-1">block</span> <span data-i18n="occupied">Occupé</span></div>
                    <div class="legend-pill border-blue-600 bg-blue-50 text-blue-700"><span class="material-icons-round text-sm mr-1">person</span> <span data-i18n="my_res">Ma rés.</span></div>
                    <div class="legend-pill border-slate-300 bg-slate-100 text-slate-500"><span class="material-icons-round text-sm mr-1">lock</span> <span data-i18n="fixed">Fixe</span></div>
                </div>
            </div>
            
            <div class="p-6 bg-slate-50/50">
                <div id="desk-map-layout" class="w-full flex flex-col gap-8 select-none pb-4">
                    <!-- Top Zone -->
                    <div class="relative bg-white border border-slate-200 rounded-2xl p-4 shadow-sm">
                        <div class="zone-header" data-i18n="zone_digital">ZONE DIGITAL / CLUSTERS</div>
                        <div id="top-row-container" class="grid grid-cols-2 md:grid-cols-4 gap-6 justify-items-center"></div>
                    </div>
                    <!-- Bottom Zones -->
                    <div class="flex flex-col md:flex-row gap-6 w-full">
                        <div class="flex-1 bg-white border border-slate-200 rounded-2xl p-4 shadow-sm">
                            <div class="zone-header" data-i18n="zone_online">ZONE ONLINE PRODUCTS</div>
                            <!-- MOBILE FIX: flex-wrap added to allow items to wrap on small screens -->
                            <div id="online-islands-container" class="flex flex-row flex-wrap gap-4 justify-center h-full items-start"></div>
                        </div>
                        <div class="flex-1 bg-white border border-slate-200 rounded-2xl p-4 shadow-sm">
                            <div class="zone-header" data-i18n="zone_design">ZONE DESIGN STUDIO</div>
                             <!-- MOBILE FIX: flex-wrap added -->
                            <div id="design-islands-container" class="flex flex-row flex-wrap gap-4 justify-center h-full items-start"></div>
                        </div>
                    </div>
                </div>
                <div class="mt-6 pt-6 border-t border-slate-200">
                      <p class="text-[10px] font-bold text-slate-400 uppercase mb-3" data-i18n="legend_dept">Départements</p>
                      <div class="flex flex-wrap gap-2" id="legend-dept-container"></div>
                </div>
            </div>
        </section>
        
        <!-- COPYRIGHT -->
        <div class="text-center text-[10px] text-slate-400 font-medium mt-8 mb-4 pb-8">
            &copy; Jerome M. - Design Studio Lead (Golden Palace)
        </div>

        <!-- Sticky Bar -->
        <div id="sticky-action-bar" class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 shadow-[0_-8px_30px_rgba(0,0,0,0.1)] z-50 p-4 md:px-8 md:py-4">
            <div class="max-w-5xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                <div id="bar-status-area" class="flex items-center gap-4 w-full md:w-auto bg-slate-50 px-4 py-2 rounded-xl border border-slate-100">
                    <div id="default-bar-status" class="flex items-center gap-3">
                         <div class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-400 shadow-sm">
                             <span class="material-icons-round">event_seat</span>
                         </div>
                         <div class="flex flex-col">
                             <span class="text-[10px] font-bold text-slate-400 uppercase" data-i18n="my_status">Mon Statut</span>
                             <span id="my-status-text" class="text-sm font-bold text-slate-700" data-i18n="no_res">Aucune réservation</span>
                         </div>
                    </div>
                    <div id="selection-bar-status" class="hidden flex items-center gap-3">
                        <!-- Golden Selection Box -->
                        <div class="w-10 h-10 rounded-xl bg-[#c39400] text-white flex items-center justify-center font-black text-lg shadow-md shadow-[#c39400]/30">
                            <span id="selected-desk-id">A1</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-[10px] font-bold text-[#c39400] uppercase" data-i18n="selection">Sélection</span>
                            <span id="selected-desk-detail" class="text-sm font-bold text-indigo-900">Libre</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <button id="quick-cancel-btn" class="hidden flex-1 md:flex-none px-5 py-3 border border-red-200 text-red-600 font-bold rounded-xl hover:bg-red-50 text-xs uppercase tracking-wide transition" data-i18n="free_my_place">Libérer ma place</button>
                    <button id="cancel-selection-btn" class="hidden flex-1 md:flex-none px-5 py-3 border border-slate-300 text-slate-600 font-bold rounded-xl hover:bg-slate-50 text-xs uppercase tracking-wide transition" data-i18n="cancel">Annuler</button>
                    <!-- Golden Confirm Button -->
                    <button id="confirm-reservation-btn" class="hidden flex-1 md:flex-none px-8 py-3 bg-[#c39400] text-white font-bold rounded-xl hover:bg-[#a37c00] shadow-lg shadow-[#c39400]/30 text-sm transform active:scale-95 transition flex items-center gap-2">
                        <span class="material-icons-round text-sm">check_circle</span> <span data-i18n="reserve">Réserver</span>
                    </button>
                    <button id="admin-delete-btn" class="hidden flex-1 md:flex-none px-6 py-3 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 shadow-lg shadow-red-200 text-sm" data-i18n="admin_free">Admin: Libérer</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, OAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, updateDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 1. CONFIG
        const appId = 'desk-booking-app'; 
        const firebaseConfig = {
          apiKey: "AIzaSyBIR1kFwjCLFi8TEh9UJWeid9nvfvGSSs4",
          authDomain: "deskreservation-8e1dc.firebaseapp.com",
          projectId: "deskreservation-8e1dc",
          storageBucket: "deskreservation-8e1dc.firebasestorage.app",
          messagingSenderId: "317414717446",
          appId: "1:317414717446:web:847a7fcb596a4abee92b87",
          measurementId: "G-W14YR02JY6"
        };
        const ADMIN_PASSWORD = "admin123"; 

        // 2. CONSTANTS
        const TRANSLATIONS = {
            fr: { main_title: "Réservation de sièges", subtitle: "Paysager - Croix de guerre 120", admin_mode: "Admin", admin_access: "Accès Admin", cancel: "Annuler", validate: "Valider", admin_config: "Configuration Admin", add_user: "Ajouter Utilisateur", edit_user: "Modifier Utilisateur", update: "Mettre à jour", fixed_rules: "Règles Fixes", add: "Ajouter", disable_desk: "Désactiver Bureau", block: "Bloquer", my_info: "Mes Informations", identity: "Identité", date: "Date", department: "Département", friday_goal: "Objectif Vendredi", fixed_days: "Jours Fixes", book_place: "Je réserve ma place", free: "Libre", occupied: "Occupé", my_res: "Ma rés.", fixed: "Fixe", zone_digital: "ZONE DIGITAL / CLUSTERS", zone_online: "ZONE ONLINE PRODUCTS", zone_design: "ZONE DESIGN STUDIO", legend_dept: "Départements", my_status: "Mon Statut", no_res: "Aucune réservation", selection: "Sélection", free_my_place: "Libérer ma place", reserve: "Réserver", admin_free: "Admin: Libérer", days: ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'], none: "Aucun", validated: "Validé ✅", fixed_place: "Place Fixe :", reserved: "Réservé :", occupied_by: "Occupé par", desk_disabled: "Bureau hors service", is_your_fixed: "C'est votre place fixe.", is_your_res: "C'est votre réservation.", release_first: "Libérez votre place actuelle d'abord.", fixed_error: "Place fixe attribuée pour ce jour.", res_confirmed: "Réservation confirmée !", place_freed: "Place libérée", select_profile: "Sélectionnez votre profil (Étape 1)", delete_confirm: "Supprimer ?", choose_placeholder: "Choisir...", all_days: "Tous les jours (L-V)", blocked_status: "Bloqué", duplicate_fixed: "Erreur: Cet utilisateur a déjà une place fixe ce jour-là", week_availability: "Disponibilités Semaine", booking_settings: "Paramètres Réservation", save_settings: "Sauvegarder", locked_date: "Date verrouillée (passée ou heure limite atteinte)", login_sso: "Connexion SSO", logout: "Déconnexion", login_title: "Espace Réservation de Sièges", login_intro: "Veuillez vous authentifier avec votre compte Microsoft pour accéder aux réservations.", login_btn_text: "Connexion SSO", login_secure: "Accès sécurisé et restreint au personnel.", status_connected: "Connecté" },
            nl: { main_title: "Stoelreservering", subtitle: "Paysager - Croix de guerre 120", admin_mode: "Admin", admin_access: "Admin Toegang", cancel: "Annuleren", validate: "Bevestigen", admin_config: "Admin Configuratie", add_user: "Gebruiker Toevoegen", edit_user: "Gebruiker Bewerken", update: "Updaten", fixed_rules: "Vaste Regels", add: "Toevoegen", disable_desk: "Bureau Blokkeren", block: "Blokkeer", my_info: "Mijn Gegevens", identity: "Identiteit", date: "Datum", department: "Afdeling", friday_goal: "Doelstelling Vrijdag", fixed_days: "Vaste Dagen", book_place: "Ik reserveer mijn plek", free: "Vrij", occupied: "Bezet", my_res: "Mijn res.", fixed: "Vast", zone_digital: "ZONE DIGITAL / CLUSTERS", zone_online: "ZONE ONLINE PRODUCTS", zone_design: "ZONE DESIGN STUDIO", legend_dept: "Afdelingen", my_status: "Mijn Status", no_res: "Geen reservatie", selection: "Selectie", free_my_place: "Mijn plek vrijgeven", reserve: "Reserveren", admin_free: "Admin: Vrijgeven", days: ['Zondag', 'Maandag', 'Dinsdag', 'Woensdag', 'Donderdag', 'Vrijdag', 'Zaterdag'], none: "Geen", validated: "Gevalideerd ✅", fixed_place: "Vaste Plek:", reserved: "Gereserveerd:", occupied_by: "Bezet door", desk_disabled: "Bureau buiten gebruik", is_your_fixed: "Dit is uw vaste plek.", is_your_res: "Dit is uw reservatie.", release_first: "Geef eerst uw huidige plek vrij.", fixed_error: "Vaste plek toegewezen voor vandaag.", res_confirmed: "Reservatie bevestigd!", place_freed: "Plek vrijgegeven", select_profile: "Selecteer uw profiel (Stap 1)", delete_confirm: "Verwijderen ?", choose_placeholder: "Kies...", all_days: "Alle dagen (M-V)", blocked_status: "Geblokkeerd", duplicate_fixed: "Fout: Deze gebruiker heeft al een vaste plaats op deze dag", week_availability: "Beschikbaarheid Week", booking_settings: "Boekingsinstellingen", save_settings: "Opslaan", locked_date: "Datum vergrendeld", login_sso: "Inloggen", logout: "Afmelden", login_title: "Stoelreservering Zone", login_intro: "Gelieve u te authenticeren met uw Microsoft-account om toegang te krijgen tot de reserveringen.", login_btn_text: "SSO Aanmelding", login_secure: "Beveiligde toegang beperkt tot personeel.", status_connected: "Verbonden" },
            en: { main_title: "Seat Reservation", subtitle: "Paysager - Croix de guerre 120", admin_mode: "Admin", admin_access: "Admin Access", cancel: "Cancel", validate: "Validate", admin_config: "Admin Configuration", add_user: "Add User", edit_user: "Edit User", update: "Update", fixed_rules: "Fixed Rules", add: "Add", disable_desk: "Disable Desk", block: "Block", my_info: "My Information", identity: "Identity", date: "Date", department: "Department", friday_goal: "Friday Goal", fixed_days: "Fixed Days", book_place: "Book my seat", free: "Free", occupied: "Taken", my_res: "My res.", fixed: "Fixed", zone_digital: "DIGITAL ZONE / CLUSTERS", zone_online: "ONLINE PRODUCTS ZONE", zone_design: "DESIGN STUDIO ZONE", legend_dept: "Departments", my_status: "My Status", no_res: "No reservation", selection: "Selection", free_my_place: "Free my seat", reserve: "Book", admin_free: "Admin: Free", days: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'], none: "None", validated: "Validated ✅", fixed_place: "Fixed Seat:", reserved: "Booked:", occupied_by: "Occupied by", desk_disabled: "Desk disabled", is_your_fixed: "This is your fixed seat.", is_your_res: "This is your booking.", release_first: "Release your current seat first.", fixed_error: "Fixed seat assigned for today.", res_confirmed: "Booking confirmed!", place_freed: "Seat released", select_profile: "Select your profile (Step 1)", delete_confirm: "Delete ?", choose_placeholder: "Choose...", all_days: "All days (M-F)", blocked_status: "Blocked", duplicate_fixed: "Error: This user already has a fixed seat on that day", week_availability: "Week Availability", booking_settings: "Booking Settings", save_settings: "Save", locked_date: "Date locked", login_sso: "Login", logout: "Logout", login_title: "Seat Reservation Area", login_intro: "Please authenticate with your Microsoft account to access reservations.", login_btn_text: "SSO Login", login_secure: "Secure access restricted to personnel.", status_connected: "Connected" }
        };

        const DEPT_COLORS = {
            'Online': 'bg-yellow-400', 'Sports Betting': 'bg-emerald-500', 'Content': 'bg-red-600', 'CRM': 'bg-fuchsia-500',
            'Digital Marketing': 'bg-cyan-500', 'SoMe': 'bg-violet-500', 'Design Studio': 'bg-orange-500',
            'Landbased': 'bg-lime-500', 'Corporate': 'bg-pink-500'
        };
        const DEFAULT_USERS_DATA = {
            'CRM': ['Charlotte Nom', 'Killian Nom', 'Maxime Nom'], 'SoMe': ['Doha Nom', 'Stella Nom', 'Juliette Nom', 'Chanel Nom'],
            'Design Studio': ['Eric Nom', 'Minh Nom', 'Julien Nom', 'Kelly Nom', 'Laure Nom', 'Ben Nom', 'Jerome Nom', 'Lucas Nom', 'Héloise Nom'],
            'Digital Marketing': ['Rollin Nom', 'Diane Nom'], 'Landbased': ['Serge Nom', 'Patricia Nom', 'Marco Nom', 'Alix Nom'],
            'Corporate': ['Alison Nom', 'Jennifer Nom'], 'Content': ['Gaëlle Nom', 'Marthijn Nom', 'Wies Nom'],
            'Sports Betting': ['Sports Betting User 1', 'Sports Betting User 2']
        };
        const DESK_LAYOUT = {
            'TOP_ROW': { groups: [ { title: 'Landbased (L1-L4)', desks: ['L1', 'L2', 'L3', 'L4'], type: 'vertical-2x2' }, { title: 'Cluster (A1-A3)', desks: ['A1', 'A2', 'A3'], type: 'triangular' }, { title: 'Cluster (A4-A6)', desks: ['A4', 'A5', 'A6'], type: 'triangular' }, { title: 'Cluster (A7-A9)', desks: ['A7', 'A8', 'A9'], type: 'triangular' } ] },
            'DESIGN_STUDIO_1': { title: 'Ilot Design 1 (D1-D8)', col1: ['D1', 'D2', 'D3', 'D4'], col2: ['D5', 'D6', 'D7', 'D8'], size: 8 },
            'DESIGN_STUDIO_2': { title: 'Ilot Design 2 (D9-D16)', col1: ['D9', 'D10', 'D11', 'D12'], col2: ['D13', 'D14', 'D15', 'D16'], size: 8 },
            'ONLINE_F': { title: 'Ilot Online 1 (F1-F8)', col1: ['F1', 'F2', 'F3', 'F4'], col2: ['F5', 'F6', 'F7', 'F8'], size: 8 },
            'ONLINE_G': { title: 'Ilot Online 2 (G1-G8)', col1: ['G1', 'G2', 'G3', 'G4'], col2: ['G5', 'G6', 'G7', 'G8'], size: 8 }
        };
        const DESKS_LIST = []; 
        Object.values(DESK_LAYOUT).forEach(section => { if(section.groups) section.groups.forEach(g => g.desks.forEach(d => DESKS_LIST.push(d))); if(section.col1) { section.col1.forEach(d => DESKS_LIST.push(d)); section.col2.forEach(d => DESKS_LIST.push(d)); } });

        // --- 3. STATE ---
        let db, auth, userId = null;
        let usersData = JSON.parse(JSON.stringify(DEFAULT_USERS_DATA));
        let fixedAssignmentsData = { 1: {}, 2: {}, 3: {}, 4: {}, 5: {} };
        let disabledDesksData = [];
        let rawReservations = {}; 
        let weekReservationsRaw = []; 
        let selectedUser = { name: null, dept: null, fixedDesk: null };
        let currentDateString = "";
        let selectedDeskId = null;
        let currentReservation = null;
        let allReservations = {};
        let isAdminMode = false;
        let currentLang = 'fr';
        let bookingRules = { cutoffHour: 5, dayOffset: 0 };
        // ADMIN EDIT STATE
        let editingUserState = null;

        // --- SSO Provider Setup ---
        const microsoftProvider = new OAuthProvider('microsoft.com');
        microsoftProvider.setCustomParameters({
            tenant: '518c8340-2cc8-4163-a985-4fc7f1040521', 
            prompt: 'select_account' 
        });
        microsoftProvider.addScope('openid');
        microsoftProvider.addScope('profile');
        microsoftProvider.addScope('email');
        microsoftProvider.addScope('User.Read');

        // --- 4. HELPERS ---
        function t(key) { return TRANSLATIONS[currentLang][key] || key; }
        function toast(msg, type) {
             const el = document.getElementById('message-area');
             el.className = `fixed top-6 left-1/2 transform -translate-x-1/2 z-[60] px-6 py-3 rounded-full shadow-2xl font-bold text-sm text-center animate-bounce-in transition-all ${type==='error'?'bg-red-500 text-white':'bg-emerald-500 text-white'}`;
             el.textContent = msg; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'), 3000);
        }
        function updateDayLabel(d) { document.getElementById('day-label').textContent = t('days')[new Date(d).getDay()]; }
        function populateAdminDaySelect() {
            const sel = document.getElementById('admin-day-select'); const currentVal = sel.value; sel.innerHTML = '';
            const days = t('days'); sel.add(new Option(t('all_days'), 'ALL'));
            for(let i=1; i<=5; i++) { sel.add(new Option(days[i], i.toString())); }
            if(currentVal) sel.value = currentVal;
        }
        function renderLegend() {
            const container = document.getElementById('legend-dept-container'); container.innerHTML = '';
            Object.keys(DEPT_COLORS).forEach(dept => {
                const color = DEPT_COLORS[dept]; const span = document.createElement('span');
                span.className = "text-[10px] font-semibold text-slate-600 flex items-center bg-white px-2 py-1 rounded border border-slate-200";
                span.innerHTML = `<span class="w-3 h-1.5 rounded-sm ${color} mr-1.5"></span>${dept}`;
                container.appendChild(span);
            });
        }
        function setupStickyBarVisibility() { document.getElementById('sticky-action-bar').classList.add('visible'); }
        function getWeekDates(currentDate) {
            const curr = new Date(currentDate);
            const day = curr.getDay() === 0 ? 7 : curr.getDay(); 
            const week = [];
            const first = curr.getDate() - day + 1;
            for (let i = 0; i < 5; i++) {
                const next = new Date(curr);
                next.setDate(first + i);
                week.push(next.toISOString().split('T')[0]);
            }
            return week;
        }
        function formatName(fullName) {
            if(!fullName) return '';
            const parts = fullName.trim().split(' ');
            if(parts.length > 1) { return `${parts[0]} ${parts[1].charAt(0)}.`; }
            return parts[0];
        }

        function initTranslations() {
            const update = (lang) => {
                currentLang = lang;
                ['fr','nl','en'].forEach(l => { const btn = document.getElementById(`lang-${l}`); if(btn) btn.className = (lang === l) ? "px-3 py-1 text-xs font-bold rounded-md bg-slate-100 text-slate-700 transition lang-btn-active" : "px-3 py-1 text-xs font-bold rounded-md text-slate-400 hover:bg-slate-50 transition lang-btn-inactive"; });
                ['fr','nl','en'].forEach(l => { const btn = document.getElementById(`overlay-lang-${l}`); if(btn) { if(lang === l) { btn.className = "text-[10px] font-bold px-2 py-1 rounded bg-[#fff8e1] text-[#c39400] transition"; } else { btn.className = "text-[10px] font-bold px-2 py-1 rounded hover:bg-slate-100 text-slate-400 transition"; } } });
                document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if(TRANSLATIONS[lang][key]) el.textContent = TRANSLATIONS[lang][key]; });
                updateDayLabel(currentDateString); updateStickyBar(); updateUserInfoCard(); populateAdminDaySelect(); renderAdminLists(); renderLegend();
                const userSel = document.getElementById('user-select'); if(userSel && userSel.options.length > 0) userSel.options[0].textContent = t('choose_placeholder');
            };
            const btnFr = document.getElementById('lang-fr'); if(btnFr) btnFr.onclick = () => update('fr');
            const btnNl = document.getElementById('lang-nl'); if(btnNl) btnNl.onclick = () => update('nl');
            const btnEn = document.getElementById('lang-en'); if(btnEn) btnEn.onclick = () => update('en');
            const ovFr = document.getElementById('overlay-lang-fr'); if(ovFr) ovFr.onclick = () => update('fr');
            const ovNl = document.getElementById('overlay-lang-nl'); if(ovNl) ovNl.onclick = () => update('nl');
            const ovEn = document.getElementById('overlay-lang-en'); if(ovEn) ovEn.onclick = () => update('en');
            update('fr');
        }

        // --- 5. LOGIC ---
        function isDateLocked(dateStr) {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            if (dateStr < todayStr) return true;
            if (dateStr === todayStr) { if (today.getHours() >= parseInt(bookingRules.cutoffHour)) { return true; } }
            return false;
        }

        function updateGlobalState() {
            allReservations = {};
            Object.keys(rawReservations).forEach(k => { allReservations[k] = { ...rawReservations[k], isFixed: false }; });
            const dayIndex = new Date(currentDateString + 'T12:00:00').getDay();
            const fixedToday = fixedAssignmentsData[dayIndex] || {};
            Object.keys(fixedToday).forEach(deskId => {
                if (!allReservations[deskId]) {
                    allReservations[deskId] = { deskId: deskId, userName: fixedToday[deskId].userName, userDepartment: fixedToday[deskId].userDepartment, isFixed: true };
                } else if(allReservations[deskId].userName === fixedToday[deskId].userName) {
                    allReservations[deskId].isFixed = true;
                }
            });
            recalculateMyStatus(fixedToday);
            renderWeeklyStats();
            renderMap(); updateStickyBar(); updateUserInfoCard();
            document.getElementById('admin-cutoff-hour').value = bookingRules.cutoffHour;
            document.getElementById('admin-day-offset').value = bookingRules.dayOffset;
            if(isAdminMode) renderAdminLists();
        }

        function renderWeeklyStats() {
             const container = document.getElementById('weekly-availability-container'); container.innerHTML = '';
             const weekDates = getWeekDates(currentDateString);
             const dayShortNames = t('days').map(d => d.substring(0,3));
             const totalCapacity = DESKS_LIST.length - disabledDesksData.length;
             weekDates.forEach((dateStr, idx) => {
                 const dayIndex = idx + 1; 
                 const isSelected = dateStr === currentDateString;
                 const reservedSet = new Set();
                 weekReservationsRaw.forEach(r => { if(r.date === dateStr && !disabledDesksData.includes(r.deskId)) reservedSet.add(r.deskId); });
                 const fixedMap = fixedAssignmentsData[dayIndex] || {};
                 Object.keys(fixedMap).forEach(dId => { if(!disabledDesksData.includes(dId)) reservedSet.add(dId); });
                 const occupied = reservedSet.size;
                 const available = Math.max(0, totalCapacity - occupied);
                 const isLocked = isDateLocked(dateStr);
                 let colorClass;
                 if (available === 0) { colorClass = 'text-red-500'; } else if (available <= 9) { colorClass = 'text-orange-500'; } else { colorClass = 'text-green-600'; }
                 let bgClass = isSelected ? 'active' : '';
                 if (isLocked) bgClass += ' locked';
                 const el = document.createElement('div'); el.className = `week-stat-card ${bgClass}`;
                 el.onclick = () => { document.getElementById('date-selector').value = dateStr; currentDateString = dateStr; updateDayLabel(dateStr); selectedDeskId = null; listenReservations(); };
                 let content = `<span class="week-stat-day">${dayShortNames[dayIndex]}</span><div class="week-stat-content"><span class="material-icons-round text-sm ${colorClass}">chair</span><span class="week-stat-count ${colorClass}">${available}</span></div>`;
                 if (isLocked) content += `<span class="week-lock-icon material-icons-round">lock</span>`;
                 el.innerHTML = content;
                 container.appendChild(el);
             });
        }

        function recalculateMyStatus(fixedToday) {
            currentReservation = null; selectedUser.fixedDesk = null;
            if(!selectedUser.name) return;
            const myFixedId = Object.keys(fixedToday).find(k => fixedToday[k].userName === selectedUser.name);
            if(myFixedId && !disabledDesksData.includes(myFixedId)) {
                selectedUser.fixedDesk = myFixedId;
                currentReservation = { deskId: myFixedId, userName: selectedUser.name, isFixed: true };
            } else {
                Object.values(allReservations).forEach(res => { if(res.userName === selectedUser.name && !res.isFixed) currentReservation = res; });
            }
        }

        function checkFridayStats() {
            if(!selectedUser.name) return;
            const m = currentDateString.substring(0, 7);
            const q = query(collection(db, `/artifacts/${appId}/public/data/desk_reservations`), where("userName", "==", selectedUser.name));
            getDocs(q).then((snap) => {
                let count = 0; snap.forEach(d => { if(d.data().date.startsWith(m) && new Date(d.data().date).getDay()===5) count++; });
                const txt = document.getElementById('user-friday-stats');
                if(count >= 1) { txt.textContent = t('validated'); txt.className = "text-sm font-bold text-green-600"; } else { txt.textContent = "0 / 1"; txt.className = "text-sm font-bold text-red-500"; }
            });
        }

        // --- 6. RENDERERS ---
        function renderMap() {
            const create = (id) => {
                const wrapper = document.createElement('div');
                wrapper.className = "desk-wrapper";
                wrapper.onclick = () => handleDeskClick(id);

                const res = allReservations[id];
                const isDisabled = disabledDesksData.includes(id);
                const isFixed = !isDisabled && res && res.isFixed;
                const isMe = currentReservation && currentReservation.deskId === id;
                const isTaken = !isDisabled && res && !isMe;
                const isSelected = selectedDeskId === id;
                
                let classes = "desk-box ";
                let content = `<span class="text-[14px] font-bold z-10 mb-1">${id}</span>`;
                let bottomStrip = "";
                let overlay = "";

                if (isDisabled) {
                    classes += "bg-slate-800 border-slate-900 text-slate-500 opacity-80 cursor-not-allowed";
                    overlay = `<div class="floating-badge bg-slate-700 text-white border-slate-600"><span class="material-icons-round text-sm">block</span></div>`;
                } else if (isFixed) {
                    classes += "bg-slate-100 border-2 border-slate-300 text-slate-500 shadow-sm";
                    const name = res ? formatName(res.userName) : '';
                    content += `<span class="text-[10px] font-bold truncate w-full text-center px-0.5 leading-tight text-slate-600 font-bold">${name}</span>`;
                    overlay = `<div class="floating-badge bg-slate-800 text-white"><span class="material-icons-round text-[12px]">lock</span></div>`;
                    const color = DEPT_COLORS[res.userDepartment] || 'bg-slate-400';
                    bottomStrip = `<div class="absolute bottom-0 left-0 right-0 h-1.5 ${color}"></div>`;
                    if (isMe) classes += " ring-4 ring-blue-300";
                } else if (isMe) {
                    classes += "bg-blue-100 border-2 border-blue-300 text-blue-700 shadow-md ring-4 ring-blue-200";
                    content += `<span class="text-[10px] font-bold text-blue-600 leading-tight">${t('my_res')}</span>`;
                } else if (isTaken) {
                    classes += "bg-red-50 border-2 border-red-200 text-red-400 shadow-sm";
                    const name = formatName(res.userName);
                    content += `<span class="text-[10px] font-bold truncate w-full text-center px-0.5 leading-tight text-red-500">${name}</span>`;
                    const color = DEPT_COLORS[res.userDepartment] || 'bg-slate-400';
                    bottomStrip = `<div class="absolute bottom-0 left-0 right-0 h-1.5 ${color}"></div>`;
                } else if (isSelected) {
                    classes += "bg-yellow-300 border-2 border-yellow-500 text-yellow-900 scale-110 shadow-xl z-20 ring-4 ring-yellow-100";
                } else {
                    classes += "bg-white border-2 border-green-200 text-green-700 hover:border-green-400 hover:shadow-md";
                }

                const isLocked = isDateLocked(currentDateString);
                if (isLocked && !isAdminMode) {
                    if (!res && !isDisabled) classes += " opacity-50 cursor-not-allowed";
                }
                if (isAdminMode) classes = classes.replace('cursor-not-allowed', 'cursor-pointer');

                const box = document.createElement('div');
                box.className = classes;
                box.innerHTML = content + bottomStrip;
                wrapper.appendChild(box);

                if (overlay) {
                    const temp = document.createElement('div');
                    temp.innerHTML = overlay;
                    while (temp.firstChild) {
                        wrapper.appendChild(temp.firstChild);
                    }
                }
                return wrapper;
            };

            const top = document.getElementById('top-row-container'); top.innerHTML='';
            const des = document.getElementById('design-islands-container'); des.innerHTML='';
            const onl = document.getElementById('online-islands-container'); onl.innerHTML='';
            
            DESK_LAYOUT.TOP_ROW.groups.forEach(g => {
                 const div = document.createElement('div'); div.className = "flex flex-col items-center p-2 rounded-xl bg-white";
                 const sub = document.createElement('div');
                 if(g.type === 'vertical-2x2') {
                     sub.className = "flex gap-2";
                     const c1=document.createElement('div'); c1.className="flex flex-col gap-2"; c1.append(create(g.desks[0]), create(g.desks[1]));
                     const c2=document.createElement('div'); c2.className="flex flex-col gap-2"; c2.append(create(g.desks[2]), create(g.desks[3]));
                     const sep = document.createElement('div'); sep.className="w-2 h-auto bg-slate-400 rounded border border-slate-500 opacity-80";
                     sub.append(c1, sep, c2);
                 } else {
                     sub.className = "flex flex-col items-center gap-1";
                     const r1=document.createElement('div'); r1.className="flex gap-1"; if(g.desks[0]) r1.append(create(g.desks[0])); if(g.desks[1]) r1.append(create(g.desks[1]));
                     const shape=document.createElement('div'); shape.className="w-16 h-2 bg-slate-400 rounded opacity-80 border border-slate-500 mb-1";
                     const r2=document.createElement('div'); if(g.desks[2]) r2.append(create(g.desks[2]));
                     sub.append(r1, shape, r2);
                 }
                 div.append(sub); top.append(div);
            });
            
            [DESK_LAYOUT.DESIGN_STUDIO_1, DESK_LAYOUT.DESIGN_STUDIO_2].forEach(i => des.appendChild(renderIsland(i, create)));
            [DESK_LAYOUT.ONLINE_F, DESK_LAYOUT.ONLINE_G].forEach(i => onl.appendChild(renderIsland(i, create)));
        }

        function renderIsland(data, createFn) {
            const div = document.createElement('div'); div.className = "flex flex-col items-center flex-1 p-2 bg-white rounded-xl";
            const grid = document.createElement('div'); grid.className = "grid gap-y-2 gap-x-4"; grid.style.gridTemplateColumns = "1fr 8px 1fr"; 
            for(let i=0; i<4; i++) {
                const d1 = createFn(data.col1[i]); d1.style.justifySelf="end";
                const d2 = createFn(data.col2[i]); d2.style.justifySelf="start";
                grid.append(d1);
                if(i===0) { 
                    const bar = document.createElement('div'); bar.className="bg-slate-400 rounded-full w-2 h-full row-span-4 opacity-80 border border-slate-500"; 
                    bar.style.gridColumn="2"; bar.style.gridRow="1 / span 4";
                    grid.append(bar);
                }
                grid.append(d2);
            }
            div.appendChild(grid); return div;
        }

        function updateStickyBar() {
            const def = document.getElementById('default-bar-status'); const sel = document.getElementById('selection-bar-status'); const myTxt = document.getElementById('my-status-text');
            const b1=document.getElementById('quick-cancel-btn'); const b2=document.getElementById('cancel-selection-btn'); const b3=document.getElementById('confirm-reservation-btn'); const b4=document.getElementById('admin-delete-btn');
            [b1,b2,b3,b4].forEach(b=>b.classList.add('hidden'));
            if(selectedDeskId) {
                def.classList.add('hidden'); sel.classList.remove('hidden');
                document.getElementById('selected-desk-id').textContent = selectedDeskId;
                const res = allReservations[selectedDeskId];
                const detail = document.getElementById('selected-desk-detail');
                if(res) {
                    detail.textContent = `${t('occupied')} (${res.userName})`; detail.className = "text-sm font-bold text-red-500";
                    if(isAdminMode) b4.classList.remove('hidden');
                } else {
                    detail.textContent = t('free'); detail.className = "text-sm font-bold text-green-500";
                    if(!isAdminMode) b3.classList.remove('hidden'); 
                }
                b2.classList.remove('hidden');
            } else {
                def.classList.remove('hidden'); sel.classList.add('hidden');
                if(currentReservation) {
                    if(currentReservation.isFixed) { myTxt.innerHTML = `${t('fixed_place')} <span class="text-indigo-600">${currentReservation.deskId}</span>`; } 
                    else { myTxt.innerHTML = `${t('reserved')} <span class="text-blue-600">${currentReservation.deskId}</span>`; b1.classList.remove('hidden'); }
                } else { myTxt.textContent = t('no_res'); }
            }
        }
        function updateUserInfoCard() {
            if(!selectedUser.name) { document.getElementById('user-info-card').classList.add('hidden'); return; }
            document.getElementById('user-info-card').classList.remove('hidden');
            const color = DEPT_COLORS[selectedUser.dept] || 'bg-slate-400';
            document.getElementById('user-dept-badge').textContent = selectedUser.dept;
            document.getElementById('user-dept-badge').className = `text-[10px] px-2 py-1 rounded-full font-bold uppercase tracking-wide inline-block text-white ${color}`;
            const daysContainer = document.getElementById('user-fixed-days'); daysContainer.innerHTML = '';
            const dayNames = t('days'); let hasFixed = false;
            const fixedDataContainer = document.createElement('div'); fixedDataContainer.className = "flex flex-col gap-1 text-sm";
            for(let i=1; i<=5; i++) {
                const dayRules = fixedAssignmentsData[i] || {};
                const desk = Object.keys(dayRules).find(d => dayRules[d].userName === selectedUser.name);
                if(desk) {
                    hasFixed = true;
                    const row = document.createElement('div'); row.className = "info-grid-row text-xs"; 
                    const dayLabel = document.createElement('span'); dayLabel.className = "font-medium text-slate-700"; dayLabel.textContent = dayNames[i];
                    const deskValue = document.createElement('span'); deskValue.className = "font-bold text-indigo-600 justify-self-end"; deskValue.textContent = desk;
                    row.appendChild(dayLabel); row.appendChild(deskValue);
                    fixedDataContainer.appendChild(row);
                }
            }
            if(!hasFixed) { fixedDataContainer.innerHTML = `<span class="text-xs italic text-slate-400">${t('none')}</span>`; }
            daysContainer.appendChild(fixedDataContainer); checkFridayStats();
        }
        function renderAdminLists() {
             const uList = document.getElementById('admin-users-list'); uList.innerHTML="";
             Object.keys(usersData).sort().forEach(dp => {
                 if(usersData[dp].length === 0) return;
                 const header = document.createElement('div'); header.className = "text-[10px] font-bold text-slate-400 mt-2 mb-1 uppercase bg-slate-50 p-1 rounded"; header.textContent = dp; uList.appendChild(header);
                 usersData[dp].sort().forEach(n => {
                     const d=document.createElement('div'); d.className="flex justify-between items-center px-2 py-1 bg-white text-[10px] border rounded mb-1";
                     d.innerHTML=`<span>${n}</span> <div class="flex gap-1"><button class="edit-user-btn text-indigo-500 font-bold hover:bg-indigo-50 rounded px-1" data-name="${n}" data-dept="${dp}"><span class="material-icons-round text-xs">edit</span></button><button class="delete-user-btn text-red-500 font-bold hover:bg-red-50 rounded px-1" data-name="${n}" data-dept="${dp}">×</button></div>`;
                     uList.appendChild(d);
                 });
             });
             // Add Listeners
             document.querySelectorAll('.delete-user-btn').forEach(b => {
                 b.onclick = async (e) => {
                     const n = e.currentTarget.getAttribute('data-name');
                     const dp = e.currentTarget.getAttribute('data-dept');
                     if(confirm(t('delete_confirm'))) { usersData[dp]=usersData[dp].filter(x=>x!==n); if(usersData[dp].length===0) delete usersData[dp]; await saveUsers(); }
                 }
             });
             document.querySelectorAll('.edit-user-btn').forEach(b => {
                 b.onclick = (e) => {
                     const n = e.currentTarget.getAttribute('data-name');
                     const dp = e.currentTarget.getAttribute('data-dept');
                     // Enter Edit Mode
                     editingUserState = { name: n, dept: dp };
                     document.getElementById('admin-new-user-name').value = n;
                     document.getElementById('admin-new-user-dept').value = dp;
                     document.getElementById('admin-add-user-btn').textContent = t('update');
                     document.getElementById('admin-add-user-btn').classList.remove('bg-slate-700');
                     document.getElementById('admin-add-user-btn').classList.add('bg-[#c39400]'); // Golden
                     document.getElementById('admin-user-action-label').textContent = t('edit_user');
                     document.getElementById('admin-cancel-edit-btn').classList.remove('hidden');
                 }
             });

             const rList = document.getElementById('admin-rules-list'); rList.innerHTML="";
             const fDay = document.getElementById('admin-day-select').value;
             const dayNames = t('days');
             for(let i=1; i<=5; i++) {
                 if(fDay!=='ALL' && i.toString()!==fDay) continue;
                 const rules = fixedAssignmentsData[i];
                 if(rules && Object.keys(rules).length > 0) {
                     const dayHeader = document.createElement('div'); dayHeader.className = "text-[10px] font-bold text-indigo-500 mt-2 mb-1 border-b border-indigo-100 pb-1"; dayHeader.textContent = dayNames[i]; rList.appendChild(dayHeader);
                     const sortedRules = Object.keys(rules).map(k => ({id: k, ...rules[k]})).sort((a,b) => { if(a.userDepartment < b.userDepartment) return -1; if(a.userDepartment > b.userDepartment) return 1; return a.userName.localeCompare(b.userName); });
                     sortedRules.forEach(r => {
                         const d=document.createElement('div'); d.className="flex justify-between items-center px-2 py-1 bg-white text-[10px] border rounded mb-1 border-l-4 border-l-slate-300";
                         d.innerHTML=`<div class="flex gap-2"><b>${r.id}</b> <span>${r.userName} <span class="text-slate-400">(${r.userDepartment})</span></span></div> <button class="text-red-500 font-bold hover:bg-red-50 px-1 rounded">×</button>`;
                         d.querySelector('button').onclick=async()=>{ delete fixedAssignmentsData[i][r.id]; await saveConfig(); };
                         rList.appendChild(d);
                     });
                 }
             }
             const dList = document.getElementById('admin-disabled-list'); dList.innerHTML="";
             disabledDesksData.sort().forEach(x => {
                 const d=document.createElement('div'); d.className="flex justify-between px-2 py-1 bg-red-50 text-[10px] border border-red-100 text-red-800 rounded mb-1";
                 d.innerHTML=`<b>${x}</b> ${t('blocked_status')} <button class="font-bold hover:bg-red-100 px-1 rounded">×</button>`;
                 d.querySelector('button').onclick=async()=>{ disabledDesksData=disabledDesksData.filter(y=>y!==x); await saveConfig(); };
                 dList.appendChild(d);
             });
        }
        function renderAdminSelectors() {
             const userSelect = document.getElementById('user-select'); const currentUserVal = userSelect.value;
             userSelect.innerHTML=`<option value="" disabled selected>${t('choose_placeholder')}</option>`;
             // GROUPED OPTIONS
             Object.keys(usersData).sort().forEach(dp => {
                 const optGroup = document.createElement('optgroup'); optGroup.label = dp;
                 usersData[dp].sort().forEach(n => { optGroup.appendChild(new Option(n, `${n}|${dp}`)); });
                 userSelect.appendChild(optGroup);
             });
             if(currentUserVal) userSelect.value = currentUserVal;

             const adminRuleSelect = document.getElementById('admin-rule-user-select'); 
             const currentAdminVal = adminRuleSelect.value; 
             adminRuleSelect.innerHTML = "";
             Object.keys(usersData).sort().forEach(dp => {
                 const optGroup = document.createElement('optgroup'); optGroup.label = dp;
                 usersData[dp].sort().forEach(n => { optGroup.appendChild(new Option(n, `${n}|${dp}`)); });
                 adminRuleSelect.appendChild(optGroup);
             });
             if(currentAdminVal) { 
                 let found=false; 
                 for(let i=0; i<adminRuleSelect.options.length; i++) { if(adminRuleSelect.options[i].value===currentAdminVal) found=true; } 
                 if(found) adminRuleSelect.value=currentAdminVal; 
             }

             const deptSelect = document.getElementById('admin-new-user-dept'); deptSelect.innerHTML = ""; Object.keys(DEPT_COLORS).sort().forEach(k => deptSelect.add(new Option(k, k)));
             const dSel = document.getElementById('admin-desk-select'); const ddSel = document.getElementById('admin-disable-desk-select');
             dSel.innerHTML = ""; ddSel.innerHTML = ""; DESKS_LIST.sort().forEach(d => { dSel.add(new Option(d,d)); ddSel.add(new Option(d,d)); });
        }

        // --- 7. INTERACTIONS & DATA IO ---
        function handleDeskClick(id) {
            if(!selectedUser.name) { toast(t('select_profile'), "error"); return; }
            const res = allReservations[id]; const isDisabled = disabledDesksData.includes(id);
            if(isAdminMode) {
                if(isDisabled) { if(confirm("Réactiver ?")) { disabledDesksData = disabledDesksData.filter(x => x!==id); saveConfig(); } return; }
                selectedDeskId = id; updateStickyBar(); renderMap(); return;
            }
            
            // LOCK CHECK
            if(isDateLocked(currentDateString)) {
                 toast(t('locked_date'), "error"); return;
            }

            if(isDisabled) { toast(t('desk_disabled'), "error"); return; }
            const isMe = (currentReservation && currentReservation.deskId === id);
            if(isMe) { toast(currentReservation.isFixed ? t('is_your_fixed') : t('is_your_res'), "info"); return; }
            if(res) { toast(`${t('occupied_by')} ${res.userName}`, "error"); return; }
            if(selectedUser.fixedDesk) { toast(t('fixed_error'), "error"); return; }
            if(currentReservation) { toast(t('release_first'), "error"); return; }
            selectedDeskId = (selectedDeskId === id) ? null : id; updateStickyBar(); renderMap();
        }

        async function confirmReservation() {
            const docId = `${currentDateString}_${selectedDeskId}`;
            await setDoc(doc(db, `/artifacts/${appId}/public/data/desk_reservations/${docId}`), { userId, userName: selectedUser.name, userDepartment: selectedUser.dept, timestamp: Date.now(), date: currentDateString, deskId: selectedDeskId });
            toast(t('res_confirmed'), "success"); selectedDeskId = null; updateGlobalState();
        }
        async function cancelMyReservation() {
            if(currentReservation && !currentReservation.isFixed) {
                await deleteDoc(doc(db, `/artifacts/${appId}/public/data/desk_reservations/${currentDateString}_${currentReservation.deskId}`));
                toast(t('place_freed'), "info"); updateGlobalState();
            }
        }
        async function adminDelete() {
             const res = allReservations[selectedDeskId];
             if(res && res.isFixed) {
                 const dayIndex = new Date(currentDateString + 'T12:00:00').getDay();
                 if(confirm("Supprimer cette règle fixe ?")) { delete fixedAssignmentsData[dayIndex][selectedDeskId]; await saveConfig(); }
             } else { await deleteDoc(doc(db, `/artifacts/${appId}/public/data/desk_reservations/${currentDateString}_${selectedDeskId}`)); }
             selectedDeskId = null;
        }

        async function updateUserInDatabase(oldName, oldDept, newName, newDept) {
            // 1. Update Users List
            if(usersData[oldDept]) {
                usersData[oldDept] = usersData[oldDept].filter(n => n !== oldName);
                if(usersData[oldDept].length === 0) delete usersData[oldDept];
            }
            if(!usersData[newDept]) usersData[newDept] = [];
            usersData[newDept].push(newName);
            await saveUsers();

            // 2. Update Fixed Assignments
            let fixedUpdated = false;
            for(let i=1; i<=5; i++) {
                const dayRules = fixedAssignmentsData[i];
                if(dayRules) {
                    Object.keys(dayRules).forEach(deskId => {
                        if(dayRules[deskId].userName === oldName) {
                            dayRules[deskId].userName = newName;
                            dayRules[deskId].userDepartment = newDept;
                            fixedUpdated = true;
                        }
                    });
                }
            }
            if(fixedUpdated) await saveConfig();

            // 3. Update Reservations (Async)
            // Note: This does simplistic migration. In a large DB, a cloud function is better.
            const q = query(collection(db, `/artifacts/${appId}/public/data/desk_reservations`), where("userName", "==", oldName));
            const snapshot = await getDocs(q);
            snapshot.forEach(async (d) => {
                await updateDoc(d.ref, { userName: newName, userDepartment: newDept });
            });
            
            toast("Utilisateur et données mis à jour", "success");
        }

        function enableAdminMode() { isAdminMode = true; document.getElementById('admin-config-panel').classList.remove('hidden'); renderAdminLists(); renderMap(); updateStickyBar(); }
        function disableAdminMode() { isAdminMode = false; document.getElementById('admin-config-panel').classList.add('hidden'); selectedDeskId = null; renderMap(); updateStickyBar(); }

        async function saveConfig() { await setDoc(doc(db, `/artifacts/${appId}/public/data/app_config/main`), { fixedAssignments: JSON.stringify(fixedAssignmentsData), disabledDesks: JSON.stringify(disabledDesksData), bookingRules: JSON.stringify(bookingRules) }); updateGlobalState(); }
        async function saveUsers() { await setDoc(doc(db, `/artifacts/${appId}/public/data/app_config/users`), { usersData: JSON.stringify(usersData) }); renderAdminSelectors(); if(isAdminMode) renderAdminLists(); }

        function listenReservations() { 
            const weekDates = getWeekDates(currentDateString);
            const qWeek = query(collection(db, `/artifacts/${appId}/public/data/desk_reservations`), where("date", "in", weekDates));
            onSnapshot(qWeek, (snap) => {
                 weekReservationsRaw = [];
                 rawReservations = {}; 
                 snap.forEach(d => {
                     const data = d.data();
                     weekReservationsRaw.push(data);
                     if(data.date === currentDateString) {
                         rawReservations[data.deskId] = data;
                     }
                 });
                 updateGlobalState();
            });
        }
        function loadConfig() { 
            onSnapshot(doc(db, `/artifacts/${appId}/public/data/app_config/main`), (s) => { 
                if(s.exists()) { 
                    const data = s.data(); 
                    try { fixedAssignmentsData = JSON.parse(data.fixedAssignments || '{}'); } catch(e) { fixedAssignmentsData = {}; } 
                    try { disabledDesksData = JSON.parse(data.disabledDesks || '[]'); } catch(e) { disabledDesksData = []; } 
                    try { bookingRules = JSON.parse(data.bookingRules || '{"cutoffHour":5, "dayOffset":0}'); } catch(e) { bookingRules = {cutoffHour:5, dayOffset:0}; }
                } else { saveConfig(); } 
                updateGlobalState(); 
            }); 
        }
        function loadUsers() { 
            onSnapshot(doc(db, `/artifacts/${appId}/public/data/app_config/users`), (s) => { 
                if(s.exists()) { 
                    const data = s.data(); 
                    try { usersData = JSON.parse(data.usersData || '{}'); } catch(e) { usersData = JSON.parse(JSON.stringify(DEFAULT_USERS_DATA)); } renderAdminSelectors(); 
                    
                    // IF LOGGED IN, RETRY AUTO SELECT AFTER LOADING USERS
                    if(auth.currentUser) autoSelectProfile(auth.currentUser.displayName);
                    
                } else { saveUsers(); } 
                if(isAdminMode) renderAdminLists(); 
            }); 
        }

        function initUserSelector() { renderAdminSelectors(); }

        function initAdminActions() {
             const dSel = document.getElementById('admin-desk-select');
             const ddSel = document.getElementById('admin-disable-desk-select');
             DESKS_LIST.sort().forEach(d => { dSel.add(new Option(d,d)); ddSel.add(new Option(d,d)); });

             document.getElementById('admin-add-user-btn').onclick = async () => {
                 const n = document.getElementById('admin-new-user-name').value.trim();
                 const dp = document.getElementById('admin-new-user-dept').value;
                 if(n && dp) { 
                     // Check if Editing
                     if(editingUserState) {
                         if(n !== editingUserState.name || dp !== editingUserState.dept) {
                             await updateUserInDatabase(editingUserState.name, editingUserState.dept, n, dp);
                         }
                         // Reset Edit State
                         editingUserState = null;
                         document.getElementById('admin-new-user-name').value = '';
                         document.getElementById('admin-add-user-btn').textContent = t('add');
                         document.getElementById('admin-add-user-btn').classList.remove('bg-[#c39400]');
                         document.getElementById('admin-add-user-btn').classList.add('bg-slate-700');
                         document.getElementById('admin-user-action-label').textContent = t('add_user');
                         document.getElementById('admin-cancel-edit-btn').classList.add('hidden');
                     } else {
                         // Normal Add
                         if(!usersData[dp]) usersData[dp] = []; 
                         if(!usersData[dp].includes(n)) { usersData[dp].push(n); await saveUsers(); toast("Utilisateur ajouté", "success"); }
                     }
                 }
             };
             
             document.getElementById('admin-cancel-edit-btn').onclick = () => {
                 editingUserState = null;
                 document.getElementById('admin-new-user-name').value = '';
                 document.getElementById('admin-add-user-btn').textContent = t('add');
                 document.getElementById('admin-add-user-btn').classList.remove('bg-[#c39400]');
                 document.getElementById('admin-add-user-btn').classList.add('bg-slate-700');
                 document.getElementById('admin-user-action-label').textContent = t('add_user');
                 document.getElementById('admin-cancel-edit-btn').classList.add('hidden');
             };

             document.getElementById('admin-add-rule-btn').onclick = async () => {
                 const day = document.getElementById('admin-day-select').value;
                 const desk = document.getElementById('admin-desk-select').value;
                 const uVal = document.getElementById('admin-rule-user-select').value;
                 if(!uVal) return;
                 const [n, dp] = uVal.split('|');
                 const checkDays = (day === 'ALL') ? [1,2,3,4,5] : [parseInt(day)];
                 let conflict = false;
                 checkDays.forEach(d => {
                     const dayData = fixedAssignmentsData[d] || {};
                     const existingDesk = Object.keys(dayData).find(k => dayData[k].userName === n);
                     if(existingDesk && existingDesk !== desk) conflict = true;
                 });
                 if(conflict) { toast(t('duplicate_fixed'), "error"); return; }
                 if(day === 'ALL') { for(let i=1; i<=5; i++) { fixedAssignmentsData[i] = fixedAssignmentsData[i]||{}; fixedAssignmentsData[i][desk] = {userName:n, userDepartment:dp}; } }
                 else { fixedAssignmentsData[day] = fixedAssignmentsData[day]||{}; fixedAssignmentsData[day][desk] = {userName:n, userDepartment:dp}; }
                 await saveConfig(); toast("Règle ajoutée", "success");
             };
             document.getElementById('admin-disable-btn').onclick = async () => {
                 const d = document.getElementById('admin-disable-desk-select').value;
                 if(!disabledDesksData.includes(d)) { disabledDesksData.push(d); await saveConfig(); toast("Bureau désactivé", "success"); }
             };
             document.getElementById('admin-save-settings-btn').onclick = async () => {
                 bookingRules.cutoffHour = document.getElementById('admin-cutoff-hour').value;
                 bookingRules.dayOffset = document.getElementById('admin-day-offset').value;
                 await saveConfig(); toast("Paramètres sauvegardés", "success");
             };
             document.getElementById('admin-day-select').onchange = renderAdminLists;
        }

        // --- AUTH LOGIC ---
        async function loginSSO() {
            // Vérification basique de l'environnement
            if (window.location.protocol === 'file:') {
                alert("Attention : L'authentification ne fonctionne pas en ouvrant le fichier localement (file://). Vous devez utiliser un serveur web local (http://localhost) ou héberger le fichier.");
                return;
            }

            try {
                // Utilisation de signInWithPopup
                const result = await signInWithPopup(auth, microsoftProvider);
                // Le résultat contient les infos user et le token
                const user = result.user;
                console.log("Connexion réussie :", user);
                toast("Bienvenue " + (user.displayName || "Utilisateur"), "success");
            } catch (error) {
                console.error("Erreur SSO détaillée:", error);
                
                let errorMsg = "Erreur inconnue.";
                
                // Gestion des erreurs courantes Firebase Auth
                switch (error.code) {
                    case 'auth/popup-closed-by-user':
                        errorMsg = "La fenêtre de connexion a été fermée.";
                        break;
                    case 'auth/cancelled-popup-request':
                        errorMsg = "Une demande de connexion est déjà en cours.";
                        break;
                    case 'auth/popup-blocked':
                        errorMsg = "Le navigateur a bloqué la fenêtre pop-up. Veuillez l'autoriser.";
                        break;
                    case 'auth/operation-not-allowed':
                        errorMsg = "Le fournisseur Microsoft n'est pas activé dans la console Firebase.";
                        break;
                    case 'auth/unauthorized-domain':
                        const currentDomain = window.location.hostname;
                        errorMsg = `DOMAINE NON AUTORISÉ : "${currentDomain}"\n\n` +
                                   `Pour corriger cela :\n` +
                                   `1. Allez dans la console Firebase > Authentication > Settings > Authorized domains.\n` +
                                   `2. Cliquez sur "Ajouter un domaine".\n` +
                                   `3. Entrez exactement : ${currentDomain}`;
                        alert(errorMsg); // Force alert for this critical setup error
                        break;
                    case 'auth/configuration-not-found':
                        errorMsg = "La configuration du fournisseur Microsoft semble incomplète dans Firebase.";
                        break;
                    default:
                        errorMsg = error.message;
                }
                
                toast("Erreur : " + errorMsg, "error");
                
                // Affiche l'erreur complète dans une alerte pour faciliter le débogage si le toast disparaît trop vite
                if (error.code !== 'auth/popup-closed-by-user' && error.code !== 'auth/unauthorized-domain') {
                    alert("Erreur technique : " + error.code + "\n\n" + error.message);
                }
            }
        }
        
        function autoSelectProfile(name) {
            if (!name) return;
            const select = document.getElementById('user-select');
            // Try exact match first, then partial
            for (let i = 0; i < select.options.length; i++) {
                if (name.toLowerCase() === select.options[i].text.toLowerCase()) {
                    select.selectedIndex = i;
                    select.dispatchEvent(new Event('change'));
                    return;
                }
            }
            // Partial Match
             for (let i = 0; i < select.options.length; i++) {
                if (name.toLowerCase().includes(select.options[i].text.toLowerCase()) || select.options[i].text.toLowerCase().includes(name.toLowerCase())) {
                    select.selectedIndex = i;
                    select.dispatchEvent(new Event('change'));
                    return;
                }
            }
        }

        function setupUIListeners() {
            const toggle = document.getElementById('admin-mode-toggle'); const bg = document.getElementById('toggle-bg'); const dot = document.querySelector('.dot');
            toggle.addEventListener('change', (e) => {
                if(e.target.checked) { dot.style.transform = 'translateX(100%)'; bg.classList.remove('bg-slate-200'); bg.classList.add('bg-red-600'); document.getElementById('password-modal').classList.remove('hidden'); document.getElementById('admin-password-input').value = ''; document.getElementById('admin-password-input').focus(); } 
                else { dot.style.transform = 'translateX(0)'; bg.classList.add('bg-slate-200'); bg.classList.remove('bg-red-600'); disableAdminMode(); }
            });
            document.getElementById('cancel-password-btn').onclick = () => { document.getElementById('password-modal').classList.add('hidden'); toggle.checked = false; dot.style.transform = 'translateX(0)'; bg.classList.add('bg-slate-200'); bg.classList.remove('bg-red-600'); };
            document.getElementById('submit-password-btn').onclick = () => { if(document.getElementById('admin-password-input').value === ADMIN_PASSWORD) { document.getElementById('password-modal').classList.add('hidden'); enableAdminMode(); } else { toast("Mot de passe incorrect", "error"); } };

            document.getElementById('user-select').addEventListener('change', (e) => { const [name, dept] = e.target.value.split('|'); selectedUser = { name, dept, fixedDesk: null }; updateUserInfoCard(); selectedDeskId = null; updateGlobalState(); });
            const dateInput = document.getElementById('date-selector'); const today = new Date().toISOString().split('T')[0]; dateInput.value = today; currentDateString = today; updateDayLabel(today);
            dateInput.addEventListener('change', (e) => { currentDateString = e.target.value; updateDayLabel(currentDateString); selectedDeskId = null; listenReservations(); });

            document.getElementById('cancel-selection-btn').onclick = () => { selectedDeskId = null; updateStickyBar(); renderMap(); };
            document.getElementById('quick-cancel-btn').onclick = cancelMyReservation;
            document.getElementById('confirm-reservation-btn').onclick = confirmReservation;
            document.getElementById('admin-delete-btn').onclick = adminDelete;
            
            // AUTH LISTENERS - MOVED TO OVERLAY BUTTON
            document.getElementById('main-login-btn').onclick = loginSSO;
            document.getElementById('logout-btn').onclick = () => signOut(auth);

            initAdminActions();
        }

        function initTranslationsAndUI() {
            initTranslations();
            setupUIListeners();
            setupStickyBarVisibility();
        }

        // --- 8. INIT ---
        async function init() {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            initTranslationsAndUI();
            
            // REMOVED INITIAL DATA LOADING - WAIT FOR AUTH
            // loadConfig();
            // loadUsers();
            
            // Replaces pure anonymous login with Auth state listener
            onAuthStateChanged(auth, (user) => {
                const overlay = document.getElementById('login-overlay');
                const appContainer = document.getElementById('app-container');
                const userArea = document.getElementById('user-logged-in');
                const authSection = document.getElementById('auth-section');
                const displayName = document.getElementById('user-display-name');
                const avatar = document.getElementById('user-avatar');

                if(user) {
                    userId = user.uid;
                    
                    // UNLOCK UI
                    overlay.classList.add('fade-out'); // triggers CSS transition
                    setTimeout(() => { overlay.classList.add('hidden'); }, 500); // Wait for transition
                    
                    appContainer.classList.remove('blur-sm', 'pointer-events-none');
                    authSection.classList.remove('opacity-0');

                    // LOAD DATA NOW
                    loadConfig();
                    loadUsers();
                    listenReservations();
                    
                    // UI Update
                    const name = user.displayName || user.email || 'User';
                    displayName.textContent = name;
                    avatar.textContent = name.charAt(0);
                    // Defer auto-select slightly to allow users list to load
                    setTimeout(() => autoSelectProfile(name), 1000); 
                } else {
                     // LOCK UI
                     userId = null;
                     overlay.classList.remove('hidden', 'fade-out');
                     appContainer.classList.add('blur-sm', 'pointer-events-none');
                     authSection.classList.add('opacity-0');
                }
            });
        }
        window.onload = init;
    </script>
</body>
</html>
